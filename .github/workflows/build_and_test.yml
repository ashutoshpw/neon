name: build_and_test
on: [push]
jobs:
  check-codestyle-rust:
    runs-on: [self-hosted, Linux]
    strategy:
      matrix:
        rust_toolchain: [ 1.58 ]
    container:
      image: zimg/rust:${{ matrix.rust_toolchain }}

    steps:
      - name: Fix permissions
        run: sudo chmod -R a+rwx /__w/

      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: true
          fetch-depth: 1

      - name: Install rust toolchain ${{ matrix.rust_toolchain }}
        run: rustup default ${{ matrix.rust_toolchain }}

      - name: rustfmt
        run: cargo fmt --all -- --check

  build-postgres:
    runs-on: [ self-hosted, Linux ]
    strategy:
      matrix:
        build_type: [ debug, release ]
        rust_toolchain: [ 1.58 ]

    container:
      image: zimg/rust:${{ matrix.rust_toolchain }}
    env:
      BUILD_TYPE: ${{ matrix.build_type }}
    steps:
      - name: Fix permissions
        run: sudo chmod -R a+rwx /__w/

      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: true
          fetch-depth: 1

      - name: Set pg revision for caching
        id: pg_ver
        run: echo ::set-output name=pg_rev::$(git rev-parse HEAD:vendor/postgres)

      - name: Cache postgres build
        id: cache_pg
        uses: actions/cache@v3
        with:
          path: tmp_install/
          key: v1-${{ runner.os }}-${{ matrix.build_type }}-pg-${{ steps.pg_ver.outputs.pg_rev }}-${{ hashFiles('Makefile') }}

      - name: Build postgres
        if: steps.cache_pg.outputs.cache-hit != 'true'
        run: COPT='-Werror' mold -run make postgres -j$(nproc)
